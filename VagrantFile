Vagrant.configure("2") do |config|
    # Global Settings
    config.vm.box = "ubuntu/focal64"
  
    # Define Swarm Manager
    config.vm.define "swarm-manager" do |manager|
      manager.vm.hostname = "swarm-manager"
      manager.vm.network "private_network", type: "dhcp"
      manager.vm.provider "virtualbox" do |vb|
        vb.memory = "2048"
        vb.cpus = 2
      end
      manager.vm.provision "shell", inline: <<-SHELL
        apt-get update
        apt-get install -y docker.io
        systemctl enable docker
        systemctl start docker
        docker swarm init --advertise-addr $(hostname -I | awk '{print $2}')
        docker swarm join-token worker -q > /vagrant/worker-token.txt
      SHELL
    end
  
    # Define Worker Nodes
    (1..2).each do |i|
      config.vm.define "swarm-worker-#{i}" do |worker|
        worker.vm.hostname = "swarm-worker-#{i}"
        worker.vm.network "private_network", type: "dhcp"
        worker.vm.provider "virtualbox" do |vb|
          vb.memory = "2048"
          vb.cpus = 2
        end
        worker.vm.provision "shell", inline: <<-SHELL
          apt-get update
          apt-get install -y docker.io
          systemctl enable docker
          systemctl start docker
          docker swarm join --token $(cat /vagrant/worker-token.txt) $(hostname -I | awk '{print $2}'):2377
        SHELL
      end
    end
  
    # Define Ansible & Jenkins Server
    config.vm.define "ansible-jenkins" do |ansible|
      ansible.vm.hostname = "ansible-jenkins"
      ansible.vm.network "private_network", type: "dhcp"
      ansible.vm.provider "virtualbox" do |vb|
        vb.memory = "4096"
        vb.cpus = 2
      end
      ansible.vm.provision "shell", inline: <<-SHELL
        apt-get update
        apt-get install -y ansible openjdk-11-jdk maven docker.io
        systemctl enable docker
        systemctl start docker
        usermod -aG docker vagrant
      SHELL
    end
  end
  